name: Update Player Data Weekly

on:
    schedule:
        # Run every Monday at 9:00 PM UTC
        - cron: '0 21 * * 1'
    workflow_dispatch: # Allow manual trigger

jobs:
    update-players:
        runs-on: ubuntu-latest
        timeout-minutes: 60 # Prevent jobs from running too long

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Validate environment
              env:
                  KICKBASE_EMAIL: ${{ secrets.KICKBASE_EMAIL }}
                  KICKBASE_PASSWORD: ${{ secrets.KICKBASE_PASSWORD }}
              run: |
                  if [ -z "$KICKBASE_EMAIL" ]; then
                    echo "âŒ KICKBASE_EMAIL secret is not set"
                    exit 1
                  fi
                  if [ -z "$KICKBASE_PASSWORD" ]; then
                    echo "âŒ KICKBASE_PASSWORD secret is not set"
                    exit 1
                  fi
                  echo "âœ… Environment validated"

            - name: Set up environment variables
              env:
                  KICKBASE_EMAIL: ${{ secrets.KICKBASE_EMAIL }}
                  KICKBASE_PASSWORD: ${{ secrets.KICKBASE_PASSWORD }}
              run: |
                  echo "KICKBASE_EMAIL=$KICKBASE_EMAIL" >> $GITHUB_ENV
                  echo "KICKBASE_PASSWORD=$KICKBASE_PASSWORD" >> $GITHUB_ENV

            - name: Check required files
              run: |
                  if [ ! -f "python/all_players.json" ]; then
                    echo "âŒ python/all_players.json not found"
                    exit 1
                  fi
                  echo "âœ… Required files exist"

            - name: Update detailed players data
              working-directory: python
              run: |
                  echo "ðŸš€ Starting player data update..."
                  python getDetailedPlayers.py
                  echo "âœ… Player data update completed"

            - name: Verify output file
              run: |
                  if [ ! -f "python/detailed_players.json" ]; then
                    echo "âŒ detailed_players.json was not created"
                    exit 1
                  fi

                  # Check if file is valid JSON
                  if ! python -m json.tool python/detailed_players.json > /dev/null 2>&1; then
                    echo "âŒ detailed_players.json is not valid JSON"
                    exit 1
                  fi

                  echo "âœ… Output file is valid"

            - name: Copy to public folder
              run: |
                  cp python/detailed_players.json public/detailed_players.json
                  echo "âœ… Copied detailed_players.json to public folder"

            - name: Check if there are changes
              id: changes
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add python/detailed_players.json public/detailed_players.json

                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                    echo "changes=false" >> $GITHUB_OUTPUT
                    echo "has_changes=false" >> $GITHUB_ENV
                  else
                    echo "Changes detected"
                    echo "changes=true" >> $GITHUB_OUTPUT
                    echo "has_changes=true" >> $GITHUB_ENV
                    
                    # Get some stats about the changes
                    LINES_CHANGED=$(git diff --staged --numstat | awk '{sum+=$1+$2} END {print sum}')
                    echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push changes
              if: steps.changes.outputs.changes == 'true'
              run: |
                  git commit -m "ðŸ¤– Weekly update of detailed player data - $(date +'%Y-%m-%d')"
                  git push
                  echo "âœ… Changes committed and pushed successfully"

            - name: Create detailed summary
              run: |
                  echo "# ðŸˆ Player Data Update Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
                    echo "## âœ… Update Successful" >> $GITHUB_STEP_SUMMARY
                    echo "- Player data has been updated" >> $GITHUB_STEP_SUMMARY
                    echo "- Changes committed to repository" >> $GITHUB_STEP_SUMMARY
                    if [ -n "${{ steps.changes.outputs.lines_changed }}" ]; then
                      echo "- Lines changed: ${{ steps.changes.outputs.lines_changed }}" >> $GITHUB_STEP_SUMMARY
                    fi
                  else
                    echo "## â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
                    echo "- No updates to player data were found" >> $GITHUB_STEP_SUMMARY
                    echo "- This could mean the data hasn't changed since last update" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## ðŸ“Š File Information" >> $GITHUB_STEP_SUMMARY
                  echo "- **File:** \`python/detailed_players.json\`" >> $GITHUB_STEP_SUMMARY

                  if [ -f "python/detailed_players.json" ]; then
                    FILE_SIZE=$(stat -c%s python/detailed_players.json)
                    echo "- **Size:** $(numfmt --to=iec-i --suffix=B $FILE_SIZE)" >> $GITHUB_STEP_SUMMARY
                    
                    # Extract date from JSON if possible
                    LAST_UPDATE=$(python -c "import json; data=json.load(open('python/detailed_players.json')); print(data.get('date', 'Unknown'))" 2>/dev/null || echo "Unknown")
                    echo "- **Last Data Date:** $LAST_UPDATE" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Handle failure
              if: failure()
              run: |
                  echo "# âŒ Player Data Update Failed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "The weekly player data update encountered an error." >> $GITHUB_STEP_SUMMARY
                  echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Common issues to check:**" >> $GITHUB_STEP_SUMMARY
                  echo "- KICKBASE_EMAIL and KICKBASE_PASSWORD secrets are valid" >> $GITHUB_STEP_SUMMARY
                  echo "- API endpoints are accessible" >> $GITHUB_STEP_SUMMARY
                  echo "- Rate limiting issues" >> $GITHUB_STEP_SUMMARY
                  echo "- Network connectivity problems" >> $GITHUB_STEP_SUMMARY
