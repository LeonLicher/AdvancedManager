name: Update Player Data Weekly

on:
    schedule:
        # Run every Monday at 9:00 PM UTC
        - cron: '0 21 * * 1'
    workflow_dispatch: # Allow manual trigger

jobs:
    update-players:
        runs-on: ubuntu-latest
        timeout-minutes: 60 # Prevent jobs from running too long

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Validate environment
              env:
                  KICKBASE_EMAIL: ${{ secrets.KICKBASE_EMAIL }}
                  KICKBASE_PASSWORD: ${{ secrets.KICKBASE_PASSWORD }}
                  BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
              run: |
                  if [ -z "$KICKBASE_EMAIL" ]; then
                    echo "âŒ KICKBASE_EMAIL secret is not set"
                    exit 1
                  fi
                  if [ -z "$KICKBASE_PASSWORD" ]; then
                    echo "âŒ KICKBASE_PASSWORD secret is not set"
                    exit 1
                  fi
                  if [ -z "$BEARER_TOKEN" ]; then
                    echo "âŒ BEARER_TOKEN secret is not set"
                    exit 1
                  fi
                  echo "âœ… Environment validated"

            - name: Set up environment variables
              env:
                  KICKBASE_EMAIL: ${{ secrets.KICKBASE_EMAIL }}
                  KICKBASE_PASSWORD: ${{ secrets.KICKBASE_PASSWORD }}
                  BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
              run: |
                  echo "KICKBASE_EMAIL=$KICKBASE_EMAIL" >> $GITHUB_ENV
                  echo "KICKBASE_PASSWORD=$KICKBASE_PASSWORD" >> $GITHUB_ENV
                  echo "BEARER_TOKEN=$BEARER_TOKEN" >> $GITHUB_ENV

            - name: Check required files
              run: |
                  if [ ! -f "python/all_players.json" ]; then
                    echo "âŒ python/all_players.json not found"
                    exit 1
                  fi
                  echo "âœ… Required files exist"

            - name: Update detailed players data
              working-directory: python
              run: |
                  echo "ðŸš€ Starting player data update..."
                  echo "ðŸ“‹ Environment variables check:"
                  echo "KICKBASE_EMAIL: ${KICKBASE_EMAIL:0:5}..." # Show first 5 chars
                  echo "KICKBASE_PASSWORD: ${KICKBASE_PASSWORD:+SET}" # Show if set
                  echo "BEARER_TOKEN: ${BEARER_TOKEN:0:10}..." # Show first 10 chars

                  echo "ðŸ“‹ Current working directory: $(pwd)"
                  echo "ðŸ“‹ Files before script run:"
                  ls -la

                  echo "ðŸ Running Python script with verbose output..."
                  python -u getDetailedPlayers.py 2>&1
                  PYTHON_EXIT_CODE=$?
                  
                  if [ $PYTHON_EXIT_CODE -eq 0 ]; then
                    echo "âœ… Python script completed successfully"
                  else
                    echo "âŒ Python script failed with exit code $PYTHON_EXIT_CODE"
                    echo "ðŸ“‹ Files after failed script run:"
                    ls -la
                    exit 1
                  fi

                  echo "ðŸ“‹ Files after script run:"
                  ls -la

            - name: Verify output file
              run: |
                  # Debug: Show current directory and list files
                  echo "ðŸ“‚ Current directory: $(pwd)"
                  echo "ðŸ“‹ Files in python directory:"
                  ls -la python/ || echo "python directory not found"

                  # Check if the file exists in the python directory
                  if [ ! -f "python/detailed_players.json" ]; then
                    echo "âŒ python/detailed_players.json not found"
                    
                    # Check if it was created in the wrong location
                    find . -name "detailed_players.json" -type f 2>/dev/null || echo "No detailed_players.json found anywhere"
                    exit 1
                  fi

                  # Check file size
                  FILE_SIZE=$(stat -c%s python/detailed_players.json)
                  echo "ðŸ“„ File size: $FILE_SIZE bytes"

                  if [ "$FILE_SIZE" -eq 0 ]; then
                    echo "âŒ detailed_players.json is empty"
                    echo "ðŸ” This suggests the Python script encountered an error or didn't write any data"
                    echo "ðŸ“‹ Check the Python script output above for error messages"
                    exit 1
                  fi

                  # Show first few lines for debugging
                  echo "ðŸ“‹ First 5 lines of the file:"
                  head -n 5 python/detailed_players.json

                  # Check if file is valid JSON
                  if ! python -c "import json; json.load(open('python/detailed_players.json'))" 2>/dev/null; then
                    echo "âŒ detailed_players.json is not valid JSON"
                    echo "ðŸ“‹ File contents (first 500 chars):"
                    head -c 500 python/detailed_players.json
                    exit 1
                  fi

                  echo "âœ… Output file is valid"

            - name: Check if there are changes
              id: changes
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add python/detailed_players.json

                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                    echo "changes=false" >> $GITHUB_OUTPUT
                    echo "has_changes=false" >> $GITHUB_ENV
                  else
                    echo "Changes detected"
                    echo "changes=true" >> $GITHUB_OUTPUT
                    echo "has_changes=true" >> $GITHUB_ENV
                    
                    # Get some stats about the changes
                    LINES_CHANGED=$(git diff --staged --numstat python/detailed_players.json | awk '{print $1 + $2}')
                    echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push changes
              if: steps.changes.outputs.changes == 'true'
              run: |
                  git commit -m "ðŸ¤– Weekly update of detailed player data - $(date +'%Y-%m-%d')"
                  git push
                  echo "âœ… Changes committed and pushed successfully"

            - name: Create detailed summary
              run: |
                  echo "# ðŸˆ Player Data Update Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ steps.changes.outputs.changes }}" == "true" ]; then
                    echo "## âœ… Update Successful" >> $GITHUB_STEP_SUMMARY
                    echo "- Player data has been updated" >> $GITHUB_STEP_SUMMARY
                    echo "- Changes committed to repository" >> $GITHUB_STEP_SUMMARY
                    if [ -n "${{ steps.changes.outputs.lines_changed }}" ]; then
                      echo "- Lines changed: ${{ steps.changes.outputs.lines_changed }}" >> $GITHUB_STEP_SUMMARY
                    fi
                  else
                    echo "## â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
                    echo "- No updates to player data were found" >> $GITHUB_STEP_SUMMARY
                    echo "- This could mean the data hasn't changed since last update" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## ðŸ“Š File Information" >> $GITHUB_STEP_SUMMARY
                  echo "- **File:** \`python/detailed_players.json\`" >> $GITHUB_STEP_SUMMARY

                  if [ -f "python/detailed_players.json" ]; then
                    FILE_SIZE=$(stat -c%s python/detailed_players.json)
                    echo "- **Size:** $(numfmt --to=iec-i --suffix=B $FILE_SIZE)" >> $GITHUB_STEP_SUMMARY
                    
                    # Extract date from JSON if possible
                    LAST_UPDATE=$(python -c "import json; data=json.load(open('python/detailed_players.json')); print(data.get('date', 'Unknown'))" 2>/dev/null || echo "Unknown")
                    echo "- **Last Data Date:** $LAST_UPDATE" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Handle failure
              if: failure()
              run: |
                  echo "# âŒ Player Data Update Failed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "The weekly player data update encountered an error." >> $GITHUB_STEP_SUMMARY
                  echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Common issues to check:**" >> $GITHUB_STEP_SUMMARY
                  echo "- BEARER_TOKEN secret is valid and not expired" >> $GITHUB_STEP_SUMMARY
                  echo "- API endpoints are accessible" >> $GITHUB_STEP_SUMMARY
                  echo "- Rate limiting issues" >> $GITHUB_STEP_SUMMARY
                  echo "- Network connectivity problems" >> $GITHUB_STEP_SUMMARY
